<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Administradores - EvaluaT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .admin-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .admin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .role-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .role-superadmin {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
        }

        .role-admin {
            background: linear-gradient(135deg, #4ecdc4, #44b3a8);
            color: white;
        }

        .status-active {
            color: #10b981;
        }

        .status-inactive {
            color: #ef4444;
        }

        /* User dropdown styles */
        .user-item {
            transition: background-color 0.2s ease;
        }

        .user-item:hover {
            background-color: #f3f4f6 !important;
        }

        #userDropdown {
            max-height: 240px;
            z-index: 99999;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4), 0 0 0 1px rgba(0,0,0,0.1);
            border: 2px solid rgba(255,255,255,0.9);
            position: fixed !important;
        }

        #userDropdown::-webkit-scrollbar {
            width: 6px;
        }

        #userDropdown::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #userDropdown::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        #userDropdown::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Navbar -->
    <nav class="glass-effect shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="admin.html" class="flex items-center text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span class="text-xl font-bold">‚Üê Dashboard Admin</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="adminInfo" class="text-white text-sm"></span>
                    <div class="relative">
                        <button id="userMenuButton" class="flex items-center text-white hover:text-gray-200 focus:outline-none z-50">
                            <i class="fas fa-user-circle text-2xl"></i>
                        </button>
                        <div id="userMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                            <button onclick="logout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">
                                <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesi√≥n
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">
                <i class="fas fa-user-shield mr-3"></i>Gesti√≥n de Administradores
            </h1>
            <p class="text-white text-opacity-80">
                Administra los usuarios con permisos de administrador en el sistema
            </p>
        </div>

        <!-- Add Admin Form -->
        <div class="glass-effect rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold text-white mb-4">
                <i class="fas fa-user-plus mr-2"></i>Agregar Nuevo Administrador
            </h2>
            
            <!-- Informaci√≥n importante -->
            <div class="bg-blue-500 bg-opacity-20 border border-blue-500 border-opacity-30 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-400 text-lg mr-3 mt-0.5"></i>
                    <div class="text-white text-sm">
                        <p class="font-medium mb-1">C√≥mo agregar administradores:</p>
                        <ul class="list-disc list-inside space-y-1 text-white text-opacity-90">
                            <li>Escribe o busca el email del usuario en el campo</li>
                            <li>Si aparecen sugerencias, puedes hacer clic para seleccionar</li>
                            <li>Tambi√©n puedes escribir cualquier email directamente</li>
                            <li>El sistema verificar√° que el usuario est√© registrado al agregarlo</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <form id="addAdminForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="relative">
                    <label for="adminEmail" class="block text-white text-sm font-medium mb-2">Email del Usuario</label>
                    
                    <!-- Campo de b√∫squeda/entrada -->
                    <div class="relative">
                        <input 
                            type="email" 
                            id="adminEmailSearch" 
                            placeholder="Buscar o escribir email..."
                            class="w-full px-3 py-2 pr-10 bg-white bg-opacity-10 border border-white border-opacity-30 rounded-md text-white placeholder-white placeholder-opacity-60 focus:outline-none focus:ring-2 focus:ring-white focus:border-transparent"
                            autocomplete="off"
                            required
                        >
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <i class="fas fa-search text-white text-opacity-60"></i>
                        </div>
                    </div>
                    
                    <!-- Dropdown de sugerencias -->
                    <div id="userDropdown" class="fixed z-50 bg-white rounded-md shadow-lg border border-gray-200 hidden max-h-60 overflow-y-auto" style="background-color: rgba(255,255,255,0.98); backdrop-filter: blur(10px); min-width: 300px;">
                        <div id="loadingUsers" class="p-3 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Cargando sugerencias...
                        </div>
                        <div id="userList" class="hidden">
                            <!-- Las sugerencias se cargar√°n aqu√≠ -->
                        </div>
                        <div id="noUsersFound" class="p-3 text-center text-gray-500 hidden">
                            <i class="fas fa-info-circle mr-2"></i>Escribe el email completo si no aparece en las sugerencias
                        </div>
                        <div id="customEmailHint" class="p-3 bg-blue-50 border-t border-blue-200 text-blue-700 text-sm hidden">
                            <i class="fas fa-lightbulb mr-2"></i>
                            <strong>Sugerencia:</strong> Puedes escribir cualquier email directamente. El sistema verificar√° si existe al agregarlo.
                        </div>
                    </div>
                </div>
                <div>
                    <label for="adminRole" class="block text-white text-sm font-medium mb-2">Rol</label>
                    <select 
                        id="adminRole" 
                        class="w-full px-3 py-2 bg-white bg-opacity-10 border border-white border-opacity-30 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-white focus:border-transparent"
                    >
                        <option value="admin" class="text-gray-800">Administrador</option>
                        <option value="superadmin" class="text-gray-800">Super Administrador</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button 
                        type="submit" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center"
                    >
                        <i class="fas fa-plus mr-2"></i>Agregar
                    </button>
                </div>
            </form>
        </div>

        <!-- Admin List -->
        <div class="glass-effect rounded-lg p-6">
            <h2 class="text-xl font-semibold text-white mb-6">
                <i class="fas fa-users-cog mr-2"></i>Administradores Actuales
            </h2>
            
            <!-- Loading State -->
            <div id="loadingAdmins" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-white text-2xl mb-2"></i>
                <p class="text-white text-opacity-80">Cargando administradores...</p>
            </div>

            <!-- Admin Grid -->
            <div id="adminGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                <!-- Admin cards will be inserted here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-8 hidden">
                <i class="fas fa-user-slash text-white text-opacity-60 text-4xl mb-4"></i>
                <p class="text-white text-opacity-80">No hay administradores registrados</p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-lg font-semibold text-gray-900 mb-4" id="modalTitle">Confirmar Acci√≥n</h3>
            <p class="text-gray-600 mb-6" id="modalMessage">¬øEst√°s seguro de que deseas realizar esta acci√≥n?</p>
            <div class="flex justify-end space-x-3">
                <button 
                    id="cancelButton" 
                    class="px-4 py-2 text-gray-500 hover:text-gray-700 font-medium"
                >
                    Cancelar
                </button>
                <button 
                    id="confirmButton" 
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-md"
                >
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

    <script type="module">
        import { 
            getCurrentUser,
            isAuthenticated,
            isAdmin,
            isSuperAdmin,
            getAdminRole,
            getAllAdmins,
            getAllRegisteredUsers,
            addAdmin,
            updateAdminStatus,
            updateAdminRole,
            signOut
        } from './supabase.js';

        // Variables globales
        let currentUserRole = 'user';
        let admins = [];
        let allUsers = [];
        let filteredUsers = [];

        // Funci√≥n logout
        window.logout = async function() {
            try {
                await signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error cerrando sesi√≥n:', error);
                showMessage('Error al cerrar sesi√≥n', 'error');
            }
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ Inicializando p√°gina de administradores...');
                
                // Check authentication
                console.log('üîç Verificando autenticaci√≥n...');
                const user = await getCurrentUser();
                console.log('üë§ Usuario obtenido:', user?.email);
                
                if (!user) {
                    console.log('‚ùå Usuario no autenticado, redirigiendo');
                    window.location.href = 'login.html';
                    return;
                }

                // Check if user is superadmin
                console.log('üëë Verificando si es superadmin...');
                const isSuperAdminUser = await isSuperAdmin();
                console.log('üîë Es superadmin:', isSuperAdminUser);
                
                if (!isSuperAdminUser) {
                    console.log('‚ùå Usuario no es superadmin');
                    showMessage('No tienes permisos para acceder a esta p√°gina', 'error');
                    setTimeout(() => {
                        window.location.href = 'admin.html';
                    }, 2000);
                    return;
                }

                console.log('üìä Obteniendo rol del usuario...');
                currentUserRole = await getAdminRole();
                console.log('üé≠ Rol obtenido:', currentUserRole);
                
                const adminInfoElement = document.getElementById('adminInfo');
                if (adminInfoElement) {
                    adminInfoElement.textContent = `${user.email} (${currentUserRole})`;
                    console.log('‚úÖ Informaci√≥n de admin actualizada en UI');
                }

                // Load admins and users
                console.log('üìã Cargando lista de administradores...');
                await loadAdmins();
                
                console.log('üë• Cargando lista de usuarios...');
                await loadUsers();

                // Setup event listeners
                console.log('üéØ Configurando event listeners...');
                setupEventListeners();
                
                console.log('üéâ Inicializaci√≥n completada exitosamente');
            } catch (error) {
                console.error('‚ùå Error initializing page:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'error');
            }
        });

        // Setup event listeners
        function setupEventListeners() {
            // User menu toggle
            document.getElementById('userMenuButton').addEventListener('click', function() {
                const menu = document.getElementById('userMenu');
                menu.classList.toggle('hidden');
            });

            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                const userMenuButton = document.getElementById('userMenuButton');
                const userMenu = document.getElementById('userMenu');
                if (!userMenuButton.contains(event.target) && !userMenu.contains(event.target)) {
                    userMenu.classList.add('hidden');
                }
            });

            // Add admin form
            document.getElementById('addAdminForm').addEventListener('submit', handleAddAdmin);

            // User search functionality
            const searchInput = document.getElementById('adminEmailSearch');
            const dropdown = document.getElementById('userDropdown');

            searchInput.addEventListener('input', handleUserSearch);
            searchInput.addEventListener('focus', showUserDropdown);
            searchInput.addEventListener('blur', function(e) {
                // Delay hiding to allow click on dropdown items
                setTimeout(() => {
                    if (!dropdown.contains(document.activeElement)) {
                        hideUserDropdown();
                    }
                }, 150);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                if (!searchInput.contains(event.target) && !dropdown.contains(event.target)) {
                    hideUserDropdown();
                }
            });

            // Reposition dropdown on scroll/resize
            window.addEventListener('scroll', repositionDropdown);
            window.addEventListener('resize', repositionDropdown);

            // Modal buttons
            document.getElementById('cancelButton').addEventListener('click', hideModal);
            document.getElementById('confirmButton').addEventListener('click', handleModalConfirm);
        }

        // Load admins
        async function loadAdmins() {
            try {
                console.log('üìã Iniciando carga de administradores...');
                
                // Mostrar loading state
                const loadingElement = document.getElementById('loadingAdmins');
                const gridElement = document.getElementById('adminGrid');
                const emptyElement = document.getElementById('emptyState');
                
                if (loadingElement) loadingElement.classList.remove('hidden');
                if (gridElement) gridElement.classList.add('hidden');
                if (emptyElement) emptyElement.classList.add('hidden');

                console.log('üîÑ Llamando a getAllAdmins()...');
                admins = await getAllAdmins();
                console.log('üìä Administradores obtenidos:', admins.length, admins);
                
                // Si no hay administradores, mostrar mensaje explicativo
                if (admins.length === 0) {
                    console.log('üì≠ No hay administradores, mostrando estado vac√≠o');
                    if (emptyElement) {
                        emptyElement.innerHTML = `
                            <i class="fas fa-user-slash text-white text-opacity-60 text-4xl mb-4"></i>
                            <p class="text-white text-opacity-80 mb-4">No hay administradores registrados</p>
                            <p class="text-white text-opacity-60 text-sm">Ingresa el primer admin</p>
                        `;
                        emptyElement.classList.remove('hidden');
                    }
                } else {
                    console.log('üé® Renderizando administradores...');
                    renderAdmins();
                    if (gridElement) gridElement.classList.remove('hidden');
                }
                
                console.log('‚úÖ Carga de administradores completada');
            } catch (error) {
                console.error('‚ùå Error loading admins:', error);
                showMessage('Error al cargar administradores: ' + error.message, 'error');
                
                // Mostrar empty state con informaci√≥n de error
                const emptyElement = document.getElementById('emptyState');
                if (emptyElement) {
                    emptyElement.innerHTML = `
                        <i class="fas fa-exclamation-triangle text-white text-opacity-60 text-4xl mb-4"></i>
                        <p class="text-white text-opacity-80 mb-4">Error al cargar administradores</p>
                        <p class="text-white text-opacity-60 text-sm">${error.message}</p>
                        <p class="text-white text-opacity-60 text-sm mt-2">Verifica que la tabla admin_users est√© configurada</p>
                    `;
                    emptyElement.classList.remove('hidden');
                }
            } finally {
                // Ocultar loading state
                const loadingElement = document.getElementById('loadingAdmins');
                if (loadingElement) loadingElement.classList.add('hidden');
            }
        }

        // Load users for dropdown
        async function loadUsers() {
            try {
                console.log('üë• Iniciando carga de usuarios...');
                
                console.log('üîÑ Llamando a getAllRegisteredUsers()...');
                allUsers = await getAllRegisteredUsers();
                console.log('üìä Usuarios obtenidos:', allUsers.length);
                
                // Filtrar usuarios que ya son administradores
                const adminEmails = admins.map(admin => admin.email);
                filteredUsers = allUsers.filter(user => !adminEmails.includes(user.email));
                
                console.log('‚úÖ Usuarios disponibles para ser admin:', filteredUsers.length);
                
            } catch (error) {
                console.error('‚ùå Error loading users:', error);
                allUsers = [];
                filteredUsers = [];
                showMessage('Error al cargar usuarios: ' + error.message, 'error');
            }
        }

        // User search and dropdown functions
        function handleUserSearch(event) {
            const searchTerm = event.target.value.toLowerCase().trim();
            
            if (!searchTerm) {
                hideUserDropdown();
                return;
            }

            if (searchTerm.length < 2) {
                return; // No buscar hasta tener al menos 2 caracteres
            }

            // Buscar en usuarios conocidos
            const filtered = filteredUsers.filter(user => 
                user.email.toLowerCase().includes(searchTerm)
            );
            
            renderUserList(filtered, searchTerm);
            showUserDropdown();
        }

        function renderUserList(users, searchTerm = '') {
            const userList = document.getElementById('userList');
            const noUsersFound = document.getElementById('noUsersFound');
            const customEmailHint = document.getElementById('customEmailHint');
            const loadingUsers = document.getElementById('loadingUsers');
            
            // Hide loading
            loadingUsers.classList.add('hidden');
            
            if (users.length === 0) {
                userList.classList.add('hidden');
                noUsersFound.classList.remove('hidden');
                
                // Mostrar hint si parece un email v√°lido
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (emailRegex.test(searchTerm)) {
                    customEmailHint.classList.remove('hidden');
                } else {
                    customEmailHint.classList.add('hidden');
                }
                return;
            }

            noUsersFound.classList.add('hidden');
            customEmailHint.classList.add('hidden');
            userList.classList.remove('hidden');
            
            userList.innerHTML = users.map(user => `
                <div class="user-item p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
                     onclick="selectUser('${user.email}')">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium text-gray-900">${user.email}</div>
                            <div class="text-sm text-gray-500">
                                <i class="fas fa-calendar mr-1"></i>
                                Registrado: ${new Date(user.created_at).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="text-sm text-blue-600">
                            <i class="fas fa-mouse-pointer"></i>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            const searchInput = document.getElementById('adminEmailSearch');
            const loadingUsers = document.getElementById('loadingUsers');
            
            if (filteredUsers.length === 0 && allUsers.length === 0) {
                loadingUsers.classList.remove('hidden');
            } else {
                loadingUsers.classList.add('hidden');
            }
            
            // Calculate position relative to the search input
            const inputRect = searchInput.getBoundingClientRect();
            const dropdownWidth = Math.max(inputRect.width, 300); // Minimum 300px width
            
            dropdown.style.left = inputRect.left + 'px';
            dropdown.style.top = (inputRect.bottom + 4) + 'px';
            dropdown.style.width = dropdownWidth + 'px';
            
            dropdown.classList.remove('hidden');
        }

        function hideUserDropdown() {
            document.getElementById('userDropdown').classList.add('hidden');
        }

        function repositionDropdown() {
            const dropdown = document.getElementById('userDropdown');
            if (!dropdown.classList.contains('hidden')) {
                showUserDropdown(); // Recalculate position
            }
        }

        function selectUser(email) {
            // Update search input with selected email
            document.getElementById('adminEmailSearch').value = email;
            
            // Hide dropdown
            hideUserDropdown();
            
            console.log('‚úÖ Usuario seleccionado:', email);
        }

        // Make selectUser available globally
        window.selectUser = selectUser;

        // Render admins
        function renderAdmins() {
            const grid = document.getElementById('adminGrid');
            grid.innerHTML = '';

            admins.forEach(admin => {
                const card = createAdminCard(admin);
                grid.appendChild(card);
            });
        }

        // Create admin card
        function createAdminCard(admin) {
            const div = document.createElement('div');
            div.className = 'admin-card bg-white bg-opacity-10 backdrop-filter backdrop-blur-lg rounded-lg p-6 border border-white border-opacity-20';
            
            const roleClass = admin.role === 'superadmin' ? 'role-superadmin' : 'role-admin';
            const statusClass = admin.is_active ? 'status-active' : 'status-inactive';
            const statusIcon = admin.is_active ? 'fa-check-circle' : 'fa-times-circle';

            div.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <h3 class="text-white font-semibold text-lg mb-1">${admin.email}</h3>
                        <span class="role-badge ${roleClass}">${admin.role}</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas ${statusIcon} ${statusClass} text-lg"></i>
                    </div>
                </div>
                
                <div class="text-white text-opacity-80 text-sm mb-4">
                    <p><i class="fas fa-calendar mr-2"></i>Creado: ${new Date(admin.created_at).toLocaleDateString()}</p>
                    ${admin.created_by_user ? `<p><i class="fas fa-user mr-2"></i>Por: ${admin.created_by_user.email}</p>` : ''}
                </div>

                <div class="flex space-x-2">
                    ${admin.is_active ? `
                        <button 
                            onclick="toggleAdminStatus('${admin.id}', false, '${admin.email}')"
                            class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white text-xs py-2 px-3 rounded-md transition-colors duration-200"
                        >
                            <i class="fas fa-pause mr-1"></i>Desactivar
                        </button>
                    ` : `
                        <button 
                            onclick="toggleAdminStatus('${admin.id}', true, '${admin.email}')"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white text-xs py-2 px-3 rounded-md transition-colors duration-200"
                        >
                            <i class="fas fa-play mr-1"></i>Activar
                        </button>
                    `}
                    
                    ${admin.role === 'admin' ? `
                        <button 
                            onclick="changeRole('${admin.id}', 'superadmin', '${admin.email}')"
                            class="flex-1 bg-purple-600 hover:bg-purple-700 text-white text-xs py-2 px-3 rounded-md transition-colors duration-200"
                        >
                            <i class="fas fa-arrow-up mr-1"></i>Promover
                        </button>
                    ` : `
                        <button 
                            onclick="changeRole('${admin.id}', 'admin', '${admin.email}')"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xs py-2 px-3 rounded-md transition-colors duration-200"
                        >
                            <i class="fas fa-arrow-down mr-1"></i>Degradar
                        </button>
                    `}
                </div>
            `;

            return div;
        }

        // Handle add admin form submission
        async function handleAddAdmin(event) {
            event.preventDefault();
            
            const email = document.getElementById('adminEmailSearch').value.trim();
            const role = document.getElementById('adminRole').value;

            if (!email) {
                showMessage('Por favor ingresa un email v√°lido', 'error');
                return;
            }

            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('Por favor ingresa un email con formato v√°lido', 'error');
                return;
            }

            try {
                console.log('üìù Intentando agregar administrador:', email, role);
                
                // Mostrar loading en el bot√≥n
                const submitButton = event.target.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Agregando...';
                submitButton.disabled = true;

                await addAdmin(email, role);
                
                showMessage('‚úÖ Administrador agregado exitosamente', 'success');
                
                // Reset form
                document.getElementById('adminEmailSearch').value = '';
                document.getElementById('adminRole').value = 'admin';
                hideUserDropdown();
                
                // Reload data
                await loadAdmins();
                await loadUsers(); // Reload to update filtered list
                
                // Restaurar bot√≥n
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                
            } catch (error) {
                console.error('‚ùå Error adding admin:', error);
                
                // Restaurar bot√≥n
                const submitButton = event.target.querySelector('button[type="submit"]');
                submitButton.innerHTML = '<i class="fas fa-plus mr-2"></i>Agregar';
                submitButton.disabled = false;
                
                // Mostrar mensaje de error espec√≠fico
                let errorMessage = 'Error al agregar administrador';
                
                if (error.message.includes('no existe en el sistema')) {
                    errorMessage = `‚ùå ${error.message}`;
                } else if (error.message.includes('ya es administrador')) {
                    errorMessage = `‚ö†Ô∏è ${error.message}`;
                } else if (error.message.includes('no tienes permisos')) {
                    errorMessage = `üö´ ${error.message}`;
                } else {
                    errorMessage = `‚ùå ${error.message}`;
                }
                
                showMessage(errorMessage, 'error');
            }
        }

        // Toggle admin status
        function toggleAdminStatus(adminId, newStatus, email) {
            const action = newStatus ? 'activar' : 'desactivar';
            showModal(
                `${action.charAt(0).toUpperCase() + action.slice(1)} Administrador`,
                `¬øEst√°s seguro de que deseas ${action} a ${email}?`,
                async () => {
                    try {
                        await updateAdminStatus(adminId, newStatus);
                        showMessage(`Administrador ${action === 'activar' ? 'activado' : 'desactivado'} exitosamente`, 'success');
                        await loadAdmins();
                    } catch (error) {
                        console.error('Error updating admin status:', error);
                        showMessage('Error al actualizar el estado del administrador', 'error');
                    }
                }
            );
        }

        // Change admin role
        function changeRole(adminId, newRole, email) {
            const action = newRole === 'superadmin' ? 'promover a Super Administrador' : 'degradar a Administrador';
            showModal(
                'Cambiar Rol',
                `¬øEst√°s seguro de que deseas ${action} a ${email}?`,
                async () => {
                    try {
                        await updateAdminRole(adminId, newRole);
                        showMessage('Rol actualizado exitosamente', 'success');
                        await loadAdmins();
                    } catch (error) {
                        console.error('Error updating admin role:', error);
                        showMessage('Error al actualizar el rol del administrador', 'error');
                    }
                }
            );
        }

        // Modal functions
        let modalConfirmCallback = null;

        function showModal(title, message, confirmCallback) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            modalConfirmCallback = confirmCallback;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            modalConfirmCallback = null;
        }

        function handleModalConfirm() {
            if (modalConfirmCallback) {
                modalConfirmCallback();
            }
            hideModal();
        }

        // Show message function
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            messageDiv.className = `${bgColor} text-white px-4 py-3 rounded-md shadow-lg mb-2 max-w-sm`;
            messageDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(messageDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
